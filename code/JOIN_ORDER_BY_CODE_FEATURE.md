# 邀请码加入订单功能实现总结

## 功能需求
学生可以通过输入邀请码来加入他人的订单，并在"我的订单"界面看到该订单及车辆信息。

## 实现方案

### 后端修改

#### 1. OrderMapper 接口 (OrderMapper.java)
- ✅ 添加 `Order selectByInvitationCode(String invitationCode)` 方法
  - 通过邀请码查询订单
  - 返回带有车辆信息的完整订单对象

#### 2. OrderMapper XML (OrderMapper.xml)
- ✅ 添加 SQL 查询语句 `selectByInvitationCode`
  - 使用 `OrderWithBusResultMap` 结果映射
  - 使用 LEFT JOIN 获取关联的车辆信息
  - WHERE 条件查询 `invitation_code`

#### 3. StudentService (StudentService.java)
- ✅ 添加 `getOrderByInvitationCode(String invitationCode)` 方法
- ✅ 业务逻辑验证：
  - 邀请码不能为空
  - 邀请码必须存在
  - 订单必须是已通过状态（"已通过"）
  - 订单必须有分配的车辆（busId 不为 null）
- ✅ 返回订单详情及车辆信息

#### 4. StudentController (StudentController.java)
- ✅ 添加 GET 端点：`/api/student/order/by-invitation-code/{invitationCode}`
  - 接收邀请码参数
  - 调用 StudentService 查询订单
  - 返回订单及车辆详情

#### 5. 编译状态
- ✅ 后端编译成功，exit code: 0

### 前端修改

#### 1. API 层 (api/index.js)
- ✅ 添加 `getOrderByInvitationCode(invitationCode)` API 调用

#### 2. 学生布局页面 (Layout.vue)
- ✅ 在侧边栏添加"加入订单"按钮
  - 位置：在"个人信息"和"退出登录"之间
  - 样式：渐变蓝紫色，带 🔗 emoji
  - 交互：点击弹出加入订单模态框

- ✅ 添加加入订单模态框
  - 标题：加入订单
  - 输入框：输入邀请码（6-8位字母数字组合）
  - 提示文本：说明邀请码用途
  - 按钮：取消/加入订单

- ✅ 脚本逻辑
  - `handleJoinOrder()` 方法：
    - 验证邀请码不为空
    - 调用 API 查询订单
    - 显示成功/错误提示
    - 成功后自动关闭模态框并跳转到"我的订单"页面
  - 支持回车键快速加入

- ✅ 样式设计
  - 模态框：玻璃态设计，带模糊效果
  - 输入框：支持大小写转换、聚焦高亮
  - 按钮：渐变色，悬停效果
  - 提示信息：滑入动画

## 功能流程

1. **学生看到邀请码**
   - 订单创建时自动生成邀请码
   - 学生可在订单页面看到邀请码
   - 学生可复制邀请码分享给其他学生

2. **其他学生输入邀请码**
   - 在侧边栏点击"加入订单"按钮
   - 在弹出窗口输入邀请码
   - 点击"加入订单"或按 Enter 键

3. **系统验证并加入**
   - 后端查询邀请码对应的订单
   - 验证订单状态（必须已通过）
   - 验证订单已有车辆分配
   - 成功则返回订单详情

4. **学生看到订单**
   - 在"我的订单"页面显示新加入的订单
   - 显示车辆信息、目的地、时间、价格等
   - 显示司机名称和电话号码

## 数据验证

### 后端验证
- ✅ 邀请码格式：非空字符串
- ✅ 订单状态：必须是"已通过"
- ✅ 车辆分配：订单必须有分配的车辆（busId ≠ null）

### 前端验证
- ✅ 邀请码不为空
- ✅ 邀请码大小写自动转换
- ✅ 加载状态提示
- ✅ 错误提示显示
- ✅ 成功提示后自动导航

## 相关文件清单

### 后端文件
- `OrderMapper.java` - 数据访问接口
- `OrderMapper.xml` - SQL 映射
- `StudentService.java` - 业务逻辑
- `StudentController.java` - API 端点

### 前端文件
- `api/index.js` - API 调用层
- `views/student/Layout.vue` - 布局页面（含加入功能）

## 使用示例

### 邀请码格式
- 示例：`ABC12345`、`XYZ67890`
- 长度：8 位（字母+数字组合）

### 使用步骤
1. 学生 A 申请包车后获得邀请码：`ABC12345`
2. 学生 A 将邀请码分享给学生 B
3. 学生 B 登录系统，点击"加入订单"
4. 学生 B 输入 `ABC12345` 并确认
5. 系统验证后，学生 B 的"我的订单"中显示该订单

## 异常处理

系统会提示以下错误信息：
- ❌ "邀请码不能为空" - 用户未输入邀请码
- ❌ "邀请码不存在或已过期" - 邀请码无效
- ❌ "该订单尚未被批准，无法加入" - 订单还在审核中
- ❌ "该订单还未分配车辆" - 订单未被管理员分配车辆

## 后续扩展建议

1. **邀请码管理**
   - 添加邀请码有效期限制
   - 添加邀请码使用次数限制
   - 邀请码黑名单功能

2. **社交功能**
   - 显示已加入该订单的学生列表
   - 订单内聊天功能
   - 合乘成本均分计算

3. **统计分析**
   - 邀请码使用统计
   - 订单分享统计
   - 学生合乘行为分析

4. **安全增强**
   - 邀请码频率限制
   - 异常登录检测
   - 邀请码加密存储（可选）
