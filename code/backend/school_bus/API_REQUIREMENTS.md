# 后端接口需求清单（API Requirements）

本文档用于描述 **Spring Boot 后端** 需要实现的接口规范，以支撑新的前端页面功能。

------

## 一、认证模块（`AuthController`）

> 负责学生与管理员的登录、注册等基础认证功能。

| 接口路径                     | 请求方式 | 接口说明   | 请求参数示例                                               |
| ---------------------------- | -------- | ---------- | ---------------------------------------------------------- |
| `/api/auth/student/login`    | `POST`   | 学生登录   | `{ "studentId": "...", "password": "..." }`                |
| `/api/auth/student/register` | `POST`   | 学生注册   | `{ "studentId": "...", "name": "...", "password": "..." }` |
| `/api/auth/admin/login`      | `POST`   | 管理员登录 | `{ "account": "admin", "password": "..." }`                |

------

## 二、学生业务模块（`StudentController`）

> 学生端核心业务接口，包括包车申请、订单管理和个人信息查看。

| 接口路径                          | 请求方式 | 接口说明     | 请求参数示例                                                 |
| --------------------------------- | -------- | ------------ | :----------------------------------------------------------- |
| `/api/student/order`              | `POST`   | 提交包车申请 | `{ "destination": "...", "usageTime": "...", "requestedCarType": "..." }` |
| `/api/student/orders/{studentId}` | `GET`    | 获取我的订单 | 无（路径参数：studentId）                                    |
| `/api/student/order/cancel/{orderId}` | `POST`   | 取消订单     | 无（仅"审核中"状态可调用）                                   |
| `/api/student/profile/{studentId}` | `GET`    | 获取个人信息 | 无（路径参数：studentId）                                    |
| `/api/student/profile/{studentId}` | `PUT`    | 修改个人信息 | `{ "name": "...", "location": "...", "password": "..." }`   |
| `/api/student/bus/{busId}`        | `GET`    | 获取车辆详情 | 无（路径参数：busId）                                        |

------

## 三、管理员业务模块（`AdminController`）

> 管理员用于订单审核、车辆管理等后台操作。

| 接口路径                         | 请求方式 | 接口说明     | 请求参数示例                                                 |
| -------------------------------- | -------- | ------------ | ------------------------------------------------------------ |
| `/api/admin/orders`              | `GET`    | 获取所有订单 | 可选参数：`?status=审核中`                                   |
| `/api/admin/order/approve`       | `POST`   | 审核通过     | `{ "orderId": 1, "busId": 1 }`                             |
| `/api/admin/order/reject`        | `POST`   | 审核拒绝     | `{ "orderId": 1, "reason": "车辆不足" }`                    |
| `/api/admin/order/revoke`        | `POST`   | 撤销订单     | `{ "orderId": 1, "reason": "用户主动撤销" }`                |
| `/api/admin/buses`               | `GET`    | 获取车辆列表 | 无                                                           |
| `/api/admin/bus`                 | `POST`   | 新增车辆     | `{ "plateNumber": "...", "carType": "...", "driverName": "..." }` |
| `/api/admin/bus/{busId}`         | `DELETE` | 删除车辆     | 无（路径参数：busId）                                        |

------

## 四、说明补充

- 所有业务接口建议统一返回格式：

```json
{
  "code": 200,
  "msg": "success",
  "data": {}
}
```

- 建议：
  - 学生接口统一通过 `Token` 鉴权
  - 管理员接口单独拦截权限
  - 订单状态建议使用枚举：`审核中 / 已通过 / 已拒绝 / 已取消`
  - 撤销订单仅限"已通过"状态的订单，撤销后状态变为"已拒绝"，车辆被释放

------

## 五、车辆删除功能说明

### 删除车辆接口特性（`DELETE /api/admin/bus/{busId}`）

当管理员删除车辆时，系统会**自动同步订单状态**，具体流程如下：

#### 🔄 自动同步流程

1. **查询相关订单**：查询所有与被删除车辆关联的订单
2. **更新订单状态**：将这些订单状态改为 `已拒绝`
3. **记录拒绝原因**：订单的拒绝原因统一设为 `车辆已删除`
4. **删除车辆**：执行车辆删除操作
5. **事务提交**：所有操作在同一事务中，确保数据一致性

#### 💡 实现细节

- **事务保证**：使用 `@Transactional` 注解，所有操作要么全部成功，要么全部回滚
- **数据完整性**：防止数据孤立，确保订单和车辆状态同步
- **用户友好**：订单被拒时明确显示原因为"车辆已删除"，便于用户了解情况

#### 📋 示例响应

```json
{
  "code": 200,
  "msg": "删除成功",
  "data": null
}
```

此时所有与该车辆关联的订单（无论原状态是什么）都将被标记为"已拒绝"，拒绝原因为"车辆已删除"。

------

## 六、新增车辆功能说明

### 新增车辆接口特性（`POST /api/admin/bus`）

当管理员新增车辆时，系统会**自动检查车牌号是否重复**，防止添加重复车辆。

#### 🔍 车牌号重复检查流程

1. **获取新增车辆信息**：接收 `plateNumber`、`carType`、`driverName` 等参数
2. **检查车牌号重复**：在数据库中查询是否存在相同车牌号的车辆
3. **拒绝重复添加**：如果车牌号已存在，返回友好的错误提示
4. **正常添加**：车牌号不重复时，正常插入新车辆

#### 💡 错误提示

当尝试添加重复车牌号时，会返回如下提示：

```json
{
  "code": 400,
  "message": "该车牌号已存在，请勿添加重复车牌号",
  "data": null
}
```

#### ✅ 成功响应

```json
{
  "code": 200,
  "msg": "添加成功",
  "data": {
    "busId": 1,
    "plateNumber": "京A12345",
    "carType": "大客车",
    "driverName": "张三",
    "isActive": true
  }
}
```

#### 🔒 实现细节

- **提前校验**：在数据库插入前进行车牌号检查，防止数据重复
- **友好提示**：错误消息明确指出"请勿添加重复车牌号"，而非通用的数据库错误
- **性能优化**：使用数据库索引查询，快速检验车牌号是否存在
