# 后端接口需求清单（API Requirements）

本文档用于描述 **Spring Boot 后端** 需要实现的接口规范，以支撑新的前端页面功能。

------

## 一、认证模块（`AuthController`）

> 负责学生与管理员的登录、注册等基础认证功能。

| 接口路径                     | 请求方式 | 接口说明   | 请求参数示例                                               |
| ---------------------------- | -------- | ---------- | ---------------------------------------------------------- |
| `/api/auth/student/login`    | `POST`   | 学生登录   | `{ "studentId": "...", "password": "..." }`                |
| `/api/auth/student/register` | `POST`   | 学生注册   | `{ "studentId": "...", "name": "...", "password": "...", "location": "..." }` |
| `/api/auth/admin/login`      | `POST`   | 管理员登录 | `{ "account": "admin", "password": "..." }`                |

------

## 二、学生业务模块（`StudentController`）

> 学生端核心业务接口，包括包车申请、订单管理和个人信息查看。

| 接口路径                          | 请求方式 | 接口说明     | 请求参数示例                                                 |
| --------------------------------- | -------- | ------------ | :----------------------------------------------------------- |
| `/api/student/order`              | `POST`   | 提交包车申请 | `{ "studentId": "...", "destination": "...", "startTime": "...", "endTime": "...", "requestedCarType": "..." }` |
| `/api/student/orders/{studentId}` | `GET`    | 获取我的订单 | 无（路径参数：studentId）                                    |
| `/api/student/order/{orderId}`    | `DELETE` | 取消订单     | 无（仅"审核中"状态可调用）                                   |
| `/api/student/profile/{studentId}`| `GET`    | 获取个人信息 | 无（路径参数：studentId）                                    |
| `/api/student/profile/{studentId}`| `PUT`    | 修改个人信息 | `{ "name": "...", "location": "...", "password": "..." }`   |
| `/api/student/bus/{busId}`        | `GET`    | 获取车辆详情 | 无（路径参数：busId）                                        |
| `/api/student/order/byInvitationCode/{code}` | `GET` | 通过邀请码查询订单 | 无（路径参数：code）|
| `/api/student/order/join`         | `POST`   | 通过邀请码加入订单 | `{ "studentId": "...", "invitationCode": "..." }`|
| `/api/student/order/refund/{orderId}` | `POST` | 申请退票 | `?studentId=xxx`（仅is_applicant=1可调用）|

------

## 三、管理员业务模块（`AdminController`）

> 管理员用于订单审核、车辆管理等后台操作。

| 接口路径                         | 请求方式 | 接口说明     | 请求参数示例                                                 |
| -------------------------------- | -------- | ------------ | ------------------------------------------------------------ |
| `/api/admin/orders`              | `GET`    | 获取所有订单 | 可选参数：`?status=审核中`                                   |
| `/api/admin/order/approve`       | `POST`   | 审核通过     | `{ "orderId": 1, "busId": 1 }`                             |
| `/api/admin/order/reject`        | `POST`   | 审核拒绝     | `{ "orderId": 1, "reason": "车辆不足" }`                    |
| `/api/admin/order/revoke`        | `POST`   | 撤销订单     | `{ "orderId": 1, "reason": "用户主动撤销" }`                |
| `/api/admin/buses`               | `GET`    | 获取车辆列表 | 无                                                           |
| `/api/admin/bus`                 | `POST`   | 新增车辆     | `{ "plateNumber": "...", "carType": "...", "driverName": "...", "price": 500, "number": "..." }` |
| `/api/admin/bus/{busId}`         | `DELETE` | 删除车辆     | 无（路径参数：busId）                                        |
| `/api/admin/bus/{busId}`         | `PUT`    | 编辑车辆     | `{ "plateNumber": "...", "carType": "...", "driverName": "...", "price": 500, "number": "..." }` |

------

## 四、响应格式规范

所有业务接口统一返回格式：

### 成功响应
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```

### 失败响应
```json
{
  "code": 400,
  "message": "错误信息描述",
  "data": null
}
```

### 通用错误码
- `200`: 操作成功
- `400`: 请求参数错误或业务异常
- `401`: 未登录或登录过期
- `403`: 无权限操作
- `404`: 资源不存在
- `500`: 服务器内部错误

------

## 五、业务规则说明

### 1. 订单状态转移

```
┌─────────────────────────────────────────────────────┐
│                   订单状态流程图                      │
└─────────────────────────────────────────────────────┘

创建订单 → [审核中] → 审核通过 → [已通过] → 申请退票 → [已退票]
                  ↓
              审核拒绝 → [已拒绝]
                  ↓
              取消订单 → [已拒绝]
```

**订单状态说明：**
- `审核中`: 订单刚创建或重新申请，等待管理员审核
- `已通过`: 管理员审核通过，车辆已分配，订单有效
- `已拒绝`: 订单被拒绝（管理员拒绝、学生取消、或车辆删除）
- `已退票`: 申请人申请了退票，同邀请码的所有订单都变为此状态

### 2. 邀请码功能

**申请人（is_applicant=1）：**
- 订单创建时自动生成邀请码（8位随机字符）
- 只有申请人可以看到邀请码
- 只有申请人可以申请退票

**加入者（is_applicant=0）：**
- 通过邀请码加入现有订单
- 看不到邀请码
- 不能申请退票

**级联退票：**
- 申请人申请退票时，同邀请码的所有订单都变为"已退票"
- 这是设计特性，表示整个拼车计划取消

### 3. 车辆删除功能说明

当管理员删除车辆时，系统会**自动同步订单状态**，具体流程如下：

#### 🔄 自动同步流程
1. **查询相关订单**：查询所有与被删除车辆关联的订单
2. **更新订单状态**：将这些订单状态改为 `已拒绝`
3. **记录拒绝原因**：订单的拒绝原因统一设为 `车辆已删除`
4. **删除车辆**：执行车辆删除操作
5. **事务提交**：所有操作在同一事务中，确保数据一致性

#### 💡 实现细节
- **事务保证**：使用 `@Transactional` 注解，所有操作要么全部成功，要么全部回滚
- **数据完整性**：防止数据孤立，确保订单和车辆状态同步
- **用户友好**：订单被拒时明确显示原因为"车辆已删除"，便于用户了解情况

### 4. 新增车辆功能说明

当管理员新增车辆时，系统会**自动检查车牌号是否重复**，防止添加重复车辆。

#### 🔍 车牌号重复检查流程
1. **获取新增车辆信息**：接收 `plateNumber`、`carType`、`driverName`、`price`、`number` 等参数
2. **检查车牌号重复**：在数据库中查询是否存在相同车牌号的车辆
3. **拒绝重复添加**：如果车牌号已存在，返回友好的错误提示
4. **正常添加**：车牌号不重复时，正常插入新车辆

#### 💡 错误提示
当尝试添加重复车牌号时，会返回如下提示：

```json
{
  "code": 400,
  "message": "该车牌号已存在，请勿添加重复车牌号",
  "data": null
}
```

#### ✅ 成功响应
```json
{
  "code": 200,
  "message": "添加成功",
  "data": {
    "busId": 1,
    "plateNumber": "京A12345",
    "carType": "大客车",
    "driverName": "张三",
    "price": 1200,
    "number": "13800138000"
  }
}
```

### 5. 时间冲突检查

**场景：** 当审核通过订单时，系统需要检查分配的车辆在对应时间段是否有其他已通过的订单。

**检查逻辑：**
- 获取订单的 `start_time` 和 `end_time`
- 在数据库中查询该车辆在此时间段内是否有其他"已通过"的订单
- 如果有时间冲突，拒绝分配此车辆

**SQL参考：**
```sql
SELECT COUNT(*) FROM t_order
WHERE bus_id = #{busId}
  AND status = '已通过'
  AND start_time IS NOT NULL
  AND end_time IS NOT NULL
  AND (
      (start_time <= #{startTime} AND end_time > #{startTime})
      OR (start_time < #{endTime} AND end_time >= #{endTime})
      OR (start_time >= #{startTime} AND end_time <= #{endTime})
  )
```

------

## 六、安全与权限

### 认证方式
- **Token鉴权**：学生接口通过 Token 验证身份
- **Session鉴权**：管理员接口通过 Session 验证权限

### 权限检查
- 学生只能查看和操作自己的订单
- 管理员可以查看所有订单和操作
- 仅申请人可以申请退票（后端严格验证）

------

## 七、建议实现顺序

1. **第一阶段**：认证模块（login/register）
2. **第二阶段**：订单管理基础（创建、查询、审核）
3. **第三阶段**：车辆管理（增删改查）
4. **第四阶段**：邀请码功能（加入、查询）
5. **第五阶段**：退票功能（级联更新）
6. **第六阶段**：优化和测试（时间冲突检查、数据一致性）
