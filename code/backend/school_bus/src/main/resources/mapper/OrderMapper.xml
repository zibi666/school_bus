<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lm.school_bus.mapper.OrderMapper">

    <resultMap id="BaseResultMap" type="com.lm.school_bus.entity.Order">
        <id column="order_id" property="orderId" />
        <result column="student_id" property="studentId" />
        <result column="destination" property="destination" />
        <result column="usage_time" property="usageTime" />
        <result column="requested_car_type" property="requestedCarType" />
        <result column="bus_id" property="busId" />
        <result column="price" property="price" />
        <result column="status" property="status" />
        <result column="reject_reason" property="rejectReason" />
        <result column="create_time" property="createTime" />
        <!-- Association for Bus details if needed, but for now we just map fields -->
    </resultMap>
    
    <!-- Result map with Bus details -->
    <resultMap id="OrderWithBusResultMap" type="com.lm.school_bus.entity.Order" extends="BaseResultMap">
        <association property="bus" javaType="com.lm.school_bus.entity.Bus">
            <id column="b_bus_id" property="busId"/>
            <result column="plate_number" property="plateNumber"/>
            <result column="car_type" property="carType"/>
            <result column="driver_name" property="driverName"/>
            <result column="is_active" property="isActive"/>
        </association>
    </resultMap>

    <sql id="Base_Column_List">
        order_id, student_id, destination, usage_time, requested_car_type, bus_id, price, status, reject_reason, create_time
    </sql>

    <select id="selectByStatusOrderByCreateTimeDesc" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        WHERE status = #{status}
        ORDER BY create_time DESC
    </select>

    <select id="selectAllOrderByCreateTimeDesc" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        ORDER BY create_time DESC
    </select>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        WHERE order_id = #{orderId}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO t_order (student_id, destination, usage_time, requested_car_type, bus_id, price, status, reject_reason, create_time)
        VALUES (#{studentId}, #{destination}, #{usageTime}, #{requestedCarType}, #{busId}, #{price}, #{status}, #{rejectReason}, NOW())
    </insert>

    <update id="update">
        UPDATE t_order
        SET student_id = #{studentId},
            destination = #{destination},
            usage_time = #{usageTime},
            requested_car_type = #{requestedCarType},
            bus_id = #{busId},
            price = #{price},
            status = #{status},
            reject_reason = #{rejectReason}
        WHERE order_id = #{orderId}
    </update>

    <delete id="deleteById">
        DELETE FROM t_order WHERE order_id = #{orderId}
    </delete>

    <select id="selectByStudentIdOrderByCreateTimeDesc" resultMap="OrderWithBusResultMap">
        SELECT 
            o.*,
            b.bus_id as b_bus_id, b.plate_number, b.car_type, b.driver_name, b.is_active
        FROM t_order o
        LEFT JOIN t_bus b ON o.bus_id = b.bus_id
        WHERE o.student_id = #{studentId}
        ORDER BY o.create_time DESC
    </select>

    <select id="selectByBusId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        WHERE bus_id = #{busId}
    </select>

</mapper>
