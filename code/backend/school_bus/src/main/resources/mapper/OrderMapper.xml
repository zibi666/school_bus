<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lm.school_bus.mapper.OrderMapper">

    <resultMap id="BaseResultMap" type="com.lm.school_bus.entity.Order">
        <id column="order_id" property="orderId" />
        <result column="student_id" property="studentId" />
        <result column="destination" property="destination" />
        <result column="start_time" property="startTime" />
        <result column="end_time" property="endTime" />
        <result column="requested_car_type" property="requestedCarType" />
        <result column="bus_id" property="busId" />
        <result column="price" property="price" />
        <result column="status" property="status" />
        <result column="reject_reason" property="rejectReason" />
        <result column="is_paid" property="isPaid" />
        <result column="invitation_code" property="invitationCode" />
        <result column="is_applicant" property="isApplicant" />
        <!-- Association for Bus details if needed, but for now we just map fields -->
    </resultMap>
    
    <!-- Result map with Bus details -->
    <resultMap id="OrderWithBusResultMap" type="com.lm.school_bus.entity.Order" extends="BaseResultMap">
        <association property="bus" javaType="com.lm.school_bus.entity.Bus">
            <id column="b_bus_id" property="busId"/>
            <result column="plate_number" property="plateNumber"/>
            <result column="car_type" property="carType"/>
            <result column="driver_name" property="driverName"/>
            <result column="number" property="number"/>
            <result column="price" property="price"/>
        </association>
    </resultMap>

    <sql id="Base_Column_List">
        order_id, student_id, destination, start_time, end_time, requested_car_type, bus_id, price, status, reject_reason, is_paid, invitation_code, is_applicant
    </sql>

    <select id="selectByStatusOrderByCreateTimeDesc" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        WHERE status = #{status}
        ORDER BY start_time DESC, order_id DESC
    </select>

    <select id="selectAllOrderByCreateTimeDesc" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        ORDER BY start_time DESC, order_id DESC
    </select>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        WHERE order_id = #{orderId}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO t_order (student_id, destination, start_time, end_time, requested_car_type, bus_id, price, status, reject_reason, is_paid, invitation_code, is_applicant)
        VALUES (#{studentId}, #{destination}, #{startTime}, #{endTime}, #{requestedCarType}, #{busId}, #{price}, #{status}, #{rejectReason}, #{isPaid}, #{invitationCode}, #{isApplicant})
    </insert>

    <update id="update">
        UPDATE t_order
        SET student_id = #{studentId},
            destination = #{destination},
            start_time = #{startTime},
            end_time = #{endTime},
            requested_car_type = #{requestedCarType},
            bus_id = #{busId},
            price = #{price},
            status = #{status},
            reject_reason = #{rejectReason},
            is_paid = #{isPaid},
            invitation_code = #{invitationCode},
            is_applicant = #{isApplicant}
        WHERE order_id = #{orderId}
    </update>

    <delete id="deleteById">
        DELETE FROM t_order WHERE order_id = #{orderId}
    </delete>

    <select id="selectByStudentIdOrderByCreateTimeDesc" resultMap="OrderWithBusResultMap">
        SELECT 
            o.*,
            b.bus_id as b_bus_id, b.plate_number, b.car_type, b.driver_name, b.number, b.price
        FROM t_order o
        LEFT JOIN t_bus b ON o.bus_id = b.bus_id
        WHERE o.student_id = #{studentId}
        ORDER BY o.start_time DESC, o.order_id DESC
    </select>

    <select id="selectByBusId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order
        WHERE bus_id = #{busId}
    </select>

    <select id="selectByInvitationCode" resultMap="OrderWithBusResultMap">
        SELECT 
            o.*,
            b.bus_id as b_bus_id, b.plate_number, b.car_type, b.driver_name, b.number, b.price
        FROM t_order o
        LEFT JOIN t_bus b ON o.bus_id = b.bus_id
        WHERE o.invitation_code = #{invitationCode}
    </select>

    <!-- 检查指定学生是否已经加入过某个订单（通过邀请码加入会创建新订单记录，此查询检查是否重复加入） -->
    <select id="selectExistingJoinedOrder" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM t_order o
        WHERE o.student_id = #{studentId}
          AND o.bus_id = (
              SELECT bus_id FROM t_order WHERE order_id = #{originalOrderId}
          )
          AND o.start_time = (
              SELECT start_time FROM t_order WHERE order_id = #{originalOrderId}
          )
          AND o.end_time = (
              SELECT end_time FROM t_order WHERE order_id = #{originalOrderId}
          )
          AND o.is_applicant = false
          AND o.status = '已通过'
    </select>

    <!-- 检查车辆在指定时间段内是否有已通过的订单（时间冲突检查） -->
    <select id="checkTimeConflict" resultType="int">
        SELECT COUNT(*) FROM t_order
        WHERE bus_id = #{busId}
          AND status = '已通过'
          AND start_time IS NOT NULL
          AND end_time IS NOT NULL
          AND (
              (start_time &lt;= #{startTime} AND end_time &gt; #{startTime})
              OR (start_time &lt; #{endTime} AND end_time &gt;= #{endTime})
              OR (start_time &gt;= #{startTime} AND end_time &lt;= #{endTime})
          )
    </select>

    <!-- 通过邀请码查询所有订单 -->
    <select id="selectByInvitationCodeAll" resultMap="OrderWithBusResultMap">
        SELECT 
            o.*,
            b.bus_id as b_bus_id, b.plate_number, b.car_type, b.driver_name, b.number, b.price
        FROM t_order o
        LEFT JOIN t_bus b ON o.bus_id = b.bus_id
        WHERE o.invitation_code = #{invitationCode}
    </select>

    <!-- 批量更新订单状态 -->
    <update id="updateStatusByInvitationCode">
        UPDATE t_order
        SET status = #{status}
        WHERE invitation_code = #{invitationCode}
    </update>

</mapper>
